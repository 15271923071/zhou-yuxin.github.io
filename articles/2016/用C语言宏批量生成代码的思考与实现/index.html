<script src="../../../style.js"></script>

<pre id="title">用C语言宏批量生成代码的思考与实现</pre>

<pre id="content">
=================阶段一：怎么用宏生成代码？====================
在#HREF"../让51单片机也像Arduino那样方便灵活地读写引脚/index.html"#-HREF1《让51单片机也像Arduino那样方便灵活地读写引脚》#-HREF2一文中，我使用了C语言的宏来“模拟”C++中的代码模板，然后通过重复书写宏来批量生成代码。用一个简单的例子可以这么来示意：
+++code
//用宏定义一个变量声明语句
#define DECLARE(n) int sqr_##n=n*n;
//在需要的地方，可以用以上宏简单的定义变量
DECLARE(0)
DECLARE(1)
DECLARE(2)
DECLARE(3)
DECLARE(4)
---code
上面的代码，预编译之后，等效于：
+++code
int sqr_0=0*0;
int sqr_1=1*1;
int sqr_2=2*2;
int sqr_3=3*3;
int sqr_4=4*4;
---code
================阶段二：用宏生成代码好处都有啥？==================
这个例子已经能够看出用宏来批量生成代码的好处了：
（1）缩短代码篇幅：如果DECLARE(n)定义的是一个有多行的函数等大篇幅的内容，那么缩短代码篇幅的作用将会很明显；
（2）可修改、可维护性提高：如果我需要修改声明语句的内容，那么只需要修改一处。
但是，这依旧不能让我满意，因为我觉得可扩展性还不够。我希望能够在某个地方指定“循环次数”来进一步精简代码与提高可维护性。大概的构想是，是否可以这么写：
+++code
//这只是一个构想
DECLARE_LOOP(4)
---code
于是就被自动扩充成
+++code
DECLARE(0)
DECLARE(1)
DECLARE(2)
DECLARE(3)
DECLARE(4)
---code
甚至连那个常数4也可以通过宏定义修改，类似于：
+++code
//这只是一个构想，不一定能够实现

#define LOOP_COUNT 4

//someting
DECLARE_LOOP(LOOP_COUNT)
---code
如果能够这样做，那么好处是显而易见的。如果哪天我需要把“循环次数”改为5，那么就不需要到处添加DECLARE(5)，只需要改一下LOOP_COUNT即可。这样就能在一个地方集中控制，减少修改遗漏，大大降低代码的维护成本。
==================阶段三：怎么实现呢？==================
可喜的是，我做到了！然而可惜的是，实现有点难看，而且目前只能在Keil于VC++编译通过，在gcc（包括MinGW）上会报错（gcc上报错的原因待会儿解释）。中间的辛酸就不提了，直接看尝试过程。
如果我定义这么一连串的宏：
+++code
#define LOOP_0 CMD(0)
#define LOOP_1 LOOP_0 CMD(1)
#define LOOP_2 LOOP_1 CMD(2)
#define LOOP_3 LOOP_2 CMD(3)
---code
那么当我写道：
+++code
LOOP_2
---code
就会被扩展成为：
+++code
CMD(0) CMD(1) CMD(2)
---code
而当我写道：
+++code
LOOP_3
---code
就会被扩展成为：
+++code
CMD(0) CMD(1) CMD(2) CMD(3)
---code
嘿，有点样子啦！这里面借助了宏的迭代，类似于函数的递归吧。
那么，如果我在写LOOP_3之前，先定义一下CMD(n)，会怎样呢？试试：
+++code
#define LOOP_0 CMD(0)
#define LOOP_1 LOOP_0 CMD(1)
#define LOOP_2 LOOP_1 CMD(2)
#define LOOP_3 LOOP_2 CMD(3)

#define DECLARE(n) int sqr_##n=n*n;

#define CMD(n) DECLARE(n)

LOOP_3
---code
结果被扩展成了：
+++code
int sqr_0=0*0; int sqr_1=1*1; int sqr_2=2*2; int sqr_3=3*3;
---code
太棒了！看来实现了我的要求，虽然是LOOP_3而不是LOOP(3)。LOOP_3的写法如果要改为LOOP(3)应该很容易呀，再增加一个定义不就OK：
+++code
#define LOOP(n) LOOP_##n
---code
继续来试试：
+++code
#define LOOP_0 CMD(0)
#define LOOP_1 LOOP_0 CMD(1)
#define LOOP_2 LOOP_1 CMD(2)
#define LOOP_3 LOOP_2 CMD(3)

#define LOOP(n) LOOP_##n

#define DECLARE(n) int sqr_##n=n*n;

#define CMD(n) DECLARE(n)

LOOP(3)
---code
展开后的结果是：
+++code
int sqr_0=0*0; int sqr_1=1*1; int sqr_2=2*2; int sqr_3=3*3;
---code
棒棒哒！离目标只差一步之遥啦，那个常数3，只要用一个宏定义不就能替换了嘛？试试呗：
+++code
#define LOOP_0 CMD(0)
#define LOOP_1 LOOP_0 CMD(1)
#define LOOP_2 LOOP_1 CMD(2)
#define LOOP_3 LOOP_2 CMD(3)

#define LOOP(n) LOOP_##n

#define DECLARE(n) int sqr_##n=n*n;

#define CMD(n) DECLARE(n)

#define LOOP_END 3

LOOP(LOOP_END)
---code
卧槽！怎么结果是这样：
+++code
LOOP_LOOP_END
---code
后来查阅了宏定义的处理细节才知道，#RED对于宏参数的处理，预处理器是先代入后替换的，而不是我希望的先替换后代入！#-RED
根据规则LOOP(n) =&gt; LOOP_##n，LOOP(LOOP_END)中的字面量“LOOP_END”直接被代入，变成了LOOP_LOOP_END，此时由于没有宏参数了，所以也就谈不上参数替换的事情了。然后预处理器去检查LOOP_LOOP_END是否还能继续展开。嗯，不能继续展开了（因为没有关于LOOP_LOOP_END的宏定义了），那么结束。
那如何才能实现先替换后代入呢？借鉴了他人的思想成果，其实很简单啦，只要这么写：
+++code
#define LOOP_0 CMD(0)
#define LOOP_1 LOOP_0 CMD(1)
#define LOOP_2 LOOP_1 CMD(2)
#define LOOP_3 LOOP_2 CMD(3)

#define LOOP_HELPER(n) LOOP_##n
#define LOOP(n) LOOP_HELPER(n)

#define DECLARE(n) int sqr_##n=n*n;

#define CMD(n) DECLARE(n)

#define LOOP_END 3

LOOP(LOOP_END)
---code
结果就正确了！
这是为啥？让我们来仔细分析一下这两句代码：
+++code
#define LOOP_HELPER(n) LOOP_##n
#define LOOP(n) LOOP_HELPER(n)
---code
当写道LOOP(LOOP_END)时，预处理根据规则LOOP(n) =&gt; LOOP_HELPER(n)，把字面量“LOOP_END”代入，于是展开成了LOOP_HELPER(LOOP_END)，现在轮到“替换”动作了，那么就是把LOOP_END替换成3，于是成了LOOP_HELPER(3)。好，第一轮迭代完成，接着预处理器检查是否有关LOOP_HELPER(n)的定义，发现有，于是根据规则LOOP_HELPER(n) =&gt; LOOP_##n，就把LOOP_HELPER(3)替换成LOOP_3，此时又轮到“替换”动作了，可是已经没有参数了，所以不管。而LOOP_3就按照递归方式一层层展开啦。
#RED这里面一个最核心的思想就是，把{ [代入,替换] , [代入,替换] , [代入,替换] &#8230;., [代入,替换] }这样一个流程，看成是{ 代入 , [替换,代入] ,  [替换 , 代入] , [替换,代入] &#8230;&#8230;, [替换,代入] , 替换 }这个一个流程。所以，只要想办法跳过第一个“代入”，那么接下来就是我们想要的“先替换后代入”啦！#-RED
==============阶段四：整理成一个头文件，方便使用==============
OK，我们只需要封装成一个头文件，那么以后就能方便的使用宏来批量生成相似的代码啦！
macro_loop.h
+++code
/*
该文件能够实现用宏来批量生成代码
使用方法举例：

//先引入头文件
#include "macro_loop.h"

//用宏指定循环截止，方便修改
//也可在下文给MACRO_LOOP传常数，但不利于维护
//名称可以任意
#define MARCO_LOOP_X 5

//自己的代码模板，名称可以任意
#define DECLARE(n) int sqr_##n=n*n;

//赋值（或者说是选中）代码模板
#define MACRO_LOOP_CMD(n) DECLARE(n)

//将最后一次选中的代码模板循环MARCO_LOOP_X+1次
//相当于写作DECLARE(0) DECLARE(1) ... DECLARE(5）
MACRO_LOOP(MARCO_LOOP_X)

*/

#ifndef MACRO_LOOP_H
#define MACRO_LOOP_H

#define MACRO_LOOP_0 MACRO_LOOP_CMD(0)
#define MACRO_LOOP_1 MACRO_LOOP_0 MACRO_LOOP_CMD(1)
#define MACRO_LOOP_2 MACRO_LOOP_1 MACRO_LOOP_CMD(2)
#define MACRO_LOOP_3 MACRO_LOOP_2 MACRO_LOOP_CMD(3)
#define MACRO_LOOP_4 MACRO_LOOP_3 MACRO_LOOP_CMD(4)
#define MACRO_LOOP_5 MACRO_LOOP_4 MACRO_LOOP_CMD(5)
#define MACRO_LOOP_6 MACRO_LOOP_5 MACRO_LOOP_CMD(6)
#define MACRO_LOOP_7 MACRO_LOOP_6 MACRO_LOOP_CMD(7)
#define MACRO_LOOP_8 MACRO_LOOP_7 MACRO_LOOP_CMD(8)
#define MACRO_LOOP_9 MACRO_LOOP_8 MACRO_LOOP_CMD(9)
#define MACRO_LOOP_10 MACRO_LOOP_9 MACRO_LOOP_CMD(10)
#define MACRO_LOOP_11 MACRO_LOOP_10 MACRO_LOOP_CMD(11)
#define MACRO_LOOP_12 MACRO_LOOP_11 MACRO_LOOP_CMD(12)
#define MACRO_LOOP_13 MACRO_LOOP_12 MACRO_LOOP_CMD(13)
#define MACRO_LOOP_14 MACRO_LOOP_13 MACRO_LOOP_CMD(14)
#define MACRO_LOOP_15 MACRO_LOOP_14 MACRO_LOOP_CMD(15)
#define MACRO_LOOP_16 MACRO_LOOP_15 MACRO_LOOP_CMD(16)
#define MACRO_LOOP_17 MACRO_LOOP_16 MACRO_LOOP_CMD(17)
#define MACRO_LOOP_18 MACRO_LOOP_17 MACRO_LOOP_CMD(18)
#define MACRO_LOOP_19 MACRO_LOOP_18 MACRO_LOOP_CMD(19)
#define MACRO_LOOP_20 MACRO_LOOP_19 MACRO_LOOP_CMD(20)
#define MACRO_LOOP_21 MACRO_LOOP_20 MACRO_LOOP_CMD(21)
#define MACRO_LOOP_22 MACRO_LOOP_21 MACRO_LOOP_CMD(22)
#define MACRO_LOOP_23 MACRO_LOOP_22 MACRO_LOOP_CMD(23)
#define MACRO_LOOP_24 MACRO_LOOP_23 MACRO_LOOP_CMD(24)
#define MACRO_LOOP_25 MACRO_LOOP_24 MACRO_LOOP_CMD(25)
#define MACRO_LOOP_26 MACRO_LOOP_25 MACRO_LOOP_CMD(26)
#define MACRO_LOOP_27 MACRO_LOOP_26 MACRO_LOOP_CMD(27)
#define MACRO_LOOP_28 MACRO_LOOP_27 MACRO_LOOP_CMD(28)
#define MACRO_LOOP_29 MACRO_LOOP_28 MACRO_LOOP_CMD(29)
#define MACRO_LOOP_30 MACRO_LOOP_29 MACRO_LOOP_CMD(30)
#define MACRO_LOOP_31 MACRO_LOOP_30 MACRO_LOOP_CMD(31)
#define MACRO_LOOP_32 MACRO_LOOP_31 MACRO_LOOP_CMD(32)
#define MACRO_LOOP_33 MACRO_LOOP_32 MACRO_LOOP_CMD(33)
#define MACRO_LOOP_34 MACRO_LOOP_33 MACRO_LOOP_CMD(34)
#define MACRO_LOOP_35 MACRO_LOOP_34 MACRO_LOOP_CMD(35)
#define MACRO_LOOP_36 MACRO_LOOP_35 MACRO_LOOP_CMD(36)
#define MACRO_LOOP_37 MACRO_LOOP_36 MACRO_LOOP_CMD(37)
#define MACRO_LOOP_38 MACRO_LOOP_37 MACRO_LOOP_CMD(38)
#define MACRO_LOOP_39 MACRO_LOOP_38 MACRO_LOOP_CMD(39)
#define MACRO_LOOP_40 MACRO_LOOP_39 MACRO_LOOP_CMD(40)
#define MACRO_LOOP_41 MACRO_LOOP_40 MACRO_LOOP_CMD(41)
#define MACRO_LOOP_42 MACRO_LOOP_41 MACRO_LOOP_CMD(42)
#define MACRO_LOOP_43 MACRO_LOOP_42 MACRO_LOOP_CMD(43)
#define MACRO_LOOP_44 MACRO_LOOP_43 MACRO_LOOP_CMD(44)
#define MACRO_LOOP_45 MACRO_LOOP_44 MACRO_LOOP_CMD(45)
#define MACRO_LOOP_46 MACRO_LOOP_45 MACRO_LOOP_CMD(46)
#define MACRO_LOOP_47 MACRO_LOOP_46 MACRO_LOOP_CMD(47)
#define MACRO_LOOP_48 MACRO_LOOP_47 MACRO_LOOP_CMD(48)
#define MACRO_LOOP_49 MACRO_LOOP_48 MACRO_LOOP_CMD(49)
#define MACRO_LOOP_50 MACRO_LOOP_49 MACRO_LOOP_CMD(50)
#define MACRO_LOOP_51 MACRO_LOOP_50 MACRO_LOOP_CMD(51)
#define MACRO_LOOP_52 MACRO_LOOP_51 MACRO_LOOP_CMD(52)
#define MACRO_LOOP_53 MACRO_LOOP_52 MACRO_LOOP_CMD(53)
#define MACRO_LOOP_54 MACRO_LOOP_53 MACRO_LOOP_CMD(54)
#define MACRO_LOOP_55 MACRO_LOOP_54 MACRO_LOOP_CMD(55)
#define MACRO_LOOP_56 MACRO_LOOP_55 MACRO_LOOP_CMD(56)
#define MACRO_LOOP_57 MACRO_LOOP_56 MACRO_LOOP_CMD(57)
#define MACRO_LOOP_58 MACRO_LOOP_57 MACRO_LOOP_CMD(58)
#define MACRO_LOOP_59 MACRO_LOOP_58 MACRO_LOOP_CMD(59)
#define MACRO_LOOP_60 MACRO_LOOP_59 MACRO_LOOP_CMD(60)
#define MACRO_LOOP_61 MACRO_LOOP_60 MACRO_LOOP_CMD(61)
#define MACRO_LOOP_62 MACRO_LOOP_61 MACRO_LOOP_CMD(62)
#define MACRO_LOOP_63 MACRO_LOOP_62 MACRO_LOOP_CMD(63)
#define MACRO_LOOP_64 MACRO_LOOP_63 MACRO_LOOP_CMD(64)
#define MACRO_LOOP_65 MACRO_LOOP_64 MACRO_LOOP_CMD(65)
#define MACRO_LOOP_66 MACRO_LOOP_65 MACRO_LOOP_CMD(66)
#define MACRO_LOOP_67 MACRO_LOOP_66 MACRO_LOOP_CMD(67)
#define MACRO_LOOP_68 MACRO_LOOP_67 MACRO_LOOP_CMD(68)
#define MACRO_LOOP_69 MACRO_LOOP_68 MACRO_LOOP_CMD(69)
#define MACRO_LOOP_70 MACRO_LOOP_69 MACRO_LOOP_CMD(70)
#define MACRO_LOOP_71 MACRO_LOOP_70 MACRO_LOOP_CMD(71)
#define MACRO_LOOP_72 MACRO_LOOP_71 MACRO_LOOP_CMD(72)
#define MACRO_LOOP_73 MACRO_LOOP_72 MACRO_LOOP_CMD(73)
#define MACRO_LOOP_74 MACRO_LOOP_73 MACRO_LOOP_CMD(74)
#define MACRO_LOOP_75 MACRO_LOOP_74 MACRO_LOOP_CMD(75)
#define MACRO_LOOP_76 MACRO_LOOP_75 MACRO_LOOP_CMD(76)
#define MACRO_LOOP_77 MACRO_LOOP_76 MACRO_LOOP_CMD(77)
#define MACRO_LOOP_78 MACRO_LOOP_77 MACRO_LOOP_CMD(78)
#define MACRO_LOOP_79 MACRO_LOOP_78 MACRO_LOOP_CMD(79)
#define MACRO_LOOP_80 MACRO_LOOP_79 MACRO_LOOP_CMD(80)
#define MACRO_LOOP_81 MACRO_LOOP_80 MACRO_LOOP_CMD(81)
#define MACRO_LOOP_82 MACRO_LOOP_81 MACRO_LOOP_CMD(82)
#define MACRO_LOOP_83 MACRO_LOOP_82 MACRO_LOOP_CMD(83)
#define MACRO_LOOP_84 MACRO_LOOP_83 MACRO_LOOP_CMD(84)
#define MACRO_LOOP_85 MACRO_LOOP_84 MACRO_LOOP_CMD(85)
#define MACRO_LOOP_86 MACRO_LOOP_85 MACRO_LOOP_CMD(86)
#define MACRO_LOOP_87 MACRO_LOOP_86 MACRO_LOOP_CMD(87)
#define MACRO_LOOP_88 MACRO_LOOP_87 MACRO_LOOP_CMD(88)
#define MACRO_LOOP_89 MACRO_LOOP_88 MACRO_LOOP_CMD(89)
#define MACRO_LOOP_90 MACRO_LOOP_89 MACRO_LOOP_CMD(90)
#define MACRO_LOOP_91 MACRO_LOOP_90 MACRO_LOOP_CMD(91)
#define MACRO_LOOP_92 MACRO_LOOP_91 MACRO_LOOP_CMD(92)
#define MACRO_LOOP_93 MACRO_LOOP_92 MACRO_LOOP_CMD(93)
#define MACRO_LOOP_94 MACRO_LOOP_93 MACRO_LOOP_CMD(94)
#define MACRO_LOOP_95 MACRO_LOOP_94 MACRO_LOOP_CMD(95)
#define MACRO_LOOP_96 MACRO_LOOP_95 MACRO_LOOP_CMD(96)
#define MACRO_LOOP_97 MACRO_LOOP_96 MACRO_LOOP_CMD(97)
#define MACRO_LOOP_98 MACRO_LOOP_97 MACRO_LOOP_CMD(98)
#define MACRO_LOOP_99 MACRO_LOOP_98 MACRO_LOOP_CMD(99)
#define MACRO_LOOP_100 MACRO_LOOP_99 MACRO_LOOP_CMD(100)
#define MACRO_LOOP_101 MACRO_LOOP_100 MACRO_LOOP_CMD(101)
#define MACRO_LOOP_102 MACRO_LOOP_101 MACRO_LOOP_CMD(102)
#define MACRO_LOOP_103 MACRO_LOOP_102 MACRO_LOOP_CMD(103)
#define MACRO_LOOP_104 MACRO_LOOP_103 MACRO_LOOP_CMD(104)
#define MACRO_LOOP_105 MACRO_LOOP_104 MACRO_LOOP_CMD(105)
#define MACRO_LOOP_106 MACRO_LOOP_105 MACRO_LOOP_CMD(106)
#define MACRO_LOOP_107 MACRO_LOOP_106 MACRO_LOOP_CMD(107)
#define MACRO_LOOP_108 MACRO_LOOP_107 MACRO_LOOP_CMD(108)
#define MACRO_LOOP_109 MACRO_LOOP_108 MACRO_LOOP_CMD(109)
#define MACRO_LOOP_110 MACRO_LOOP_109 MACRO_LOOP_CMD(110)
#define MACRO_LOOP_111 MACRO_LOOP_110 MACRO_LOOP_CMD(111)
#define MACRO_LOOP_112 MACRO_LOOP_111 MACRO_LOOP_CMD(112)
#define MACRO_LOOP_113 MACRO_LOOP_112 MACRO_LOOP_CMD(113)
#define MACRO_LOOP_114 MACRO_LOOP_113 MACRO_LOOP_CMD(114)
#define MACRO_LOOP_115 MACRO_LOOP_114 MACRO_LOOP_CMD(115)
#define MACRO_LOOP_116 MACRO_LOOP_115 MACRO_LOOP_CMD(116)
#define MACRO_LOOP_117 MACRO_LOOP_116 MACRO_LOOP_CMD(117)
#define MACRO_LOOP_118 MACRO_LOOP_117 MACRO_LOOP_CMD(118)
#define MACRO_LOOP_119 MACRO_LOOP_118 MACRO_LOOP_CMD(119)
#define MACRO_LOOP_120 MACRO_LOOP_119 MACRO_LOOP_CMD(120)
#define MACRO_LOOP_121 MACRO_LOOP_120 MACRO_LOOP_CMD(121)
#define MACRO_LOOP_122 MACRO_LOOP_121 MACRO_LOOP_CMD(122)
#define MACRO_LOOP_123 MACRO_LOOP_122 MACRO_LOOP_CMD(123)
#define MACRO_LOOP_124 MACRO_LOOP_123 MACRO_LOOP_CMD(124)
#define MACRO_LOOP_125 MACRO_LOOP_124 MACRO_LOOP_CMD(125)
#define MACRO_LOOP_126 MACRO_LOOP_125 MACRO_LOOP_CMD(126)
#define MACRO_LOOP_127 MACRO_LOOP_126 MACRO_LOOP_CMD(127)
#define MACRO_LOOP_128 MACRO_LOOP_127 MACRO_LOOP_CMD(128)
#define MACRO_LOOP_129 MACRO_LOOP_128 MACRO_LOOP_CMD(129)
#define MACRO_LOOP_130 MACRO_LOOP_129 MACRO_LOOP_CMD(130)
#define MACRO_LOOP_131 MACRO_LOOP_130 MACRO_LOOP_CMD(131)
#define MACRO_LOOP_132 MACRO_LOOP_131 MACRO_LOOP_CMD(132)
#define MACRO_LOOP_133 MACRO_LOOP_132 MACRO_LOOP_CMD(133)
#define MACRO_LOOP_134 MACRO_LOOP_133 MACRO_LOOP_CMD(134)
#define MACRO_LOOP_135 MACRO_LOOP_134 MACRO_LOOP_CMD(135)
#define MACRO_LOOP_136 MACRO_LOOP_135 MACRO_LOOP_CMD(136)
#define MACRO_LOOP_137 MACRO_LOOP_136 MACRO_LOOP_CMD(137)
#define MACRO_LOOP_138 MACRO_LOOP_137 MACRO_LOOP_CMD(138)
#define MACRO_LOOP_139 MACRO_LOOP_138 MACRO_LOOP_CMD(139)
#define MACRO_LOOP_140 MACRO_LOOP_139 MACRO_LOOP_CMD(140)
#define MACRO_LOOP_141 MACRO_LOOP_140 MACRO_LOOP_CMD(141)
#define MACRO_LOOP_142 MACRO_LOOP_141 MACRO_LOOP_CMD(142)
#define MACRO_LOOP_143 MACRO_LOOP_142 MACRO_LOOP_CMD(143)
#define MACRO_LOOP_144 MACRO_LOOP_143 MACRO_LOOP_CMD(144)
#define MACRO_LOOP_145 MACRO_LOOP_144 MACRO_LOOP_CMD(145)
#define MACRO_LOOP_146 MACRO_LOOP_145 MACRO_LOOP_CMD(146)
#define MACRO_LOOP_147 MACRO_LOOP_146 MACRO_LOOP_CMD(147)
#define MACRO_LOOP_148 MACRO_LOOP_147 MACRO_LOOP_CMD(148)
#define MACRO_LOOP_149 MACRO_LOOP_148 MACRO_LOOP_CMD(149)
#define MACRO_LOOP_150 MACRO_LOOP_149 MACRO_LOOP_CMD(150)
#define MACRO_LOOP_151 MACRO_LOOP_150 MACRO_LOOP_CMD(151)
#define MACRO_LOOP_152 MACRO_LOOP_151 MACRO_LOOP_CMD(152)
#define MACRO_LOOP_153 MACRO_LOOP_152 MACRO_LOOP_CMD(153)
#define MACRO_LOOP_154 MACRO_LOOP_153 MACRO_LOOP_CMD(154)
#define MACRO_LOOP_155 MACRO_LOOP_154 MACRO_LOOP_CMD(155)
#define MACRO_LOOP_156 MACRO_LOOP_155 MACRO_LOOP_CMD(156)
#define MACRO_LOOP_157 MACRO_LOOP_156 MACRO_LOOP_CMD(157)
#define MACRO_LOOP_158 MACRO_LOOP_157 MACRO_LOOP_CMD(158)
#define MACRO_LOOP_159 MACRO_LOOP_158 MACRO_LOOP_CMD(159)
#define MACRO_LOOP_160 MACRO_LOOP_159 MACRO_LOOP_CMD(160)
#define MACRO_LOOP_161 MACRO_LOOP_160 MACRO_LOOP_CMD(161)
#define MACRO_LOOP_162 MACRO_LOOP_161 MACRO_LOOP_CMD(162)
#define MACRO_LOOP_163 MACRO_LOOP_162 MACRO_LOOP_CMD(163)
#define MACRO_LOOP_164 MACRO_LOOP_163 MACRO_LOOP_CMD(164)
#define MACRO_LOOP_165 MACRO_LOOP_164 MACRO_LOOP_CMD(165)
#define MACRO_LOOP_166 MACRO_LOOP_165 MACRO_LOOP_CMD(166)
#define MACRO_LOOP_167 MACRO_LOOP_166 MACRO_LOOP_CMD(167)
#define MACRO_LOOP_168 MACRO_LOOP_167 MACRO_LOOP_CMD(168)
#define MACRO_LOOP_169 MACRO_LOOP_168 MACRO_LOOP_CMD(169)
#define MACRO_LOOP_170 MACRO_LOOP_169 MACRO_LOOP_CMD(170)
#define MACRO_LOOP_171 MACRO_LOOP_170 MACRO_LOOP_CMD(171)
#define MACRO_LOOP_172 MACRO_LOOP_171 MACRO_LOOP_CMD(172)
#define MACRO_LOOP_173 MACRO_LOOP_172 MACRO_LOOP_CMD(173)
#define MACRO_LOOP_174 MACRO_LOOP_173 MACRO_LOOP_CMD(174)
#define MACRO_LOOP_175 MACRO_LOOP_174 MACRO_LOOP_CMD(175)
#define MACRO_LOOP_176 MACRO_LOOP_175 MACRO_LOOP_CMD(176)
#define MACRO_LOOP_177 MACRO_LOOP_176 MACRO_LOOP_CMD(177)
#define MACRO_LOOP_178 MACRO_LOOP_177 MACRO_LOOP_CMD(178)
#define MACRO_LOOP_179 MACRO_LOOP_178 MACRO_LOOP_CMD(179)
#define MACRO_LOOP_180 MACRO_LOOP_179 MACRO_LOOP_CMD(180)
#define MACRO_LOOP_181 MACRO_LOOP_180 MACRO_LOOP_CMD(181)
#define MACRO_LOOP_182 MACRO_LOOP_181 MACRO_LOOP_CMD(182)
#define MACRO_LOOP_183 MACRO_LOOP_182 MACRO_LOOP_CMD(183)
#define MACRO_LOOP_184 MACRO_LOOP_183 MACRO_LOOP_CMD(184)
#define MACRO_LOOP_185 MACRO_LOOP_184 MACRO_LOOP_CMD(185)
#define MACRO_LOOP_186 MACRO_LOOP_185 MACRO_LOOP_CMD(186)
#define MACRO_LOOP_187 MACRO_LOOP_186 MACRO_LOOP_CMD(187)
#define MACRO_LOOP_188 MACRO_LOOP_187 MACRO_LOOP_CMD(188)
#define MACRO_LOOP_189 MACRO_LOOP_188 MACRO_LOOP_CMD(189)
#define MACRO_LOOP_190 MACRO_LOOP_189 MACRO_LOOP_CMD(190)
#define MACRO_LOOP_191 MACRO_LOOP_190 MACRO_LOOP_CMD(191)
#define MACRO_LOOP_192 MACRO_LOOP_191 MACRO_LOOP_CMD(192)
#define MACRO_LOOP_193 MACRO_LOOP_192 MACRO_LOOP_CMD(193)
#define MACRO_LOOP_194 MACRO_LOOP_193 MACRO_LOOP_CMD(194)
#define MACRO_LOOP_195 MACRO_LOOP_194 MACRO_LOOP_CMD(195)
#define MACRO_LOOP_196 MACRO_LOOP_195 MACRO_LOOP_CMD(196)
#define MACRO_LOOP_197 MACRO_LOOP_196 MACRO_LOOP_CMD(197)
#define MACRO_LOOP_198 MACRO_LOOP_197 MACRO_LOOP_CMD(198)
#define MACRO_LOOP_199 MACRO_LOOP_198 MACRO_LOOP_CMD(199)
#define MACRO_LOOP_200 MACRO_LOOP_199 MACRO_LOOP_CMD(200)
#define MACRO_LOOP_201 MACRO_LOOP_200 MACRO_LOOP_CMD(201)
#define MACRO_LOOP_202 MACRO_LOOP_201 MACRO_LOOP_CMD(202)
#define MACRO_LOOP_203 MACRO_LOOP_202 MACRO_LOOP_CMD(203)
#define MACRO_LOOP_204 MACRO_LOOP_203 MACRO_LOOP_CMD(204)
#define MACRO_LOOP_205 MACRO_LOOP_204 MACRO_LOOP_CMD(205)
#define MACRO_LOOP_206 MACRO_LOOP_205 MACRO_LOOP_CMD(206)
#define MACRO_LOOP_207 MACRO_LOOP_206 MACRO_LOOP_CMD(207)
#define MACRO_LOOP_208 MACRO_LOOP_207 MACRO_LOOP_CMD(208)
#define MACRO_LOOP_209 MACRO_LOOP_208 MACRO_LOOP_CMD(209)
#define MACRO_LOOP_210 MACRO_LOOP_209 MACRO_LOOP_CMD(210)
#define MACRO_LOOP_211 MACRO_LOOP_210 MACRO_LOOP_CMD(211)
#define MACRO_LOOP_212 MACRO_LOOP_211 MACRO_LOOP_CMD(212)
#define MACRO_LOOP_213 MACRO_LOOP_212 MACRO_LOOP_CMD(213)
#define MACRO_LOOP_214 MACRO_LOOP_213 MACRO_LOOP_CMD(214)
#define MACRO_LOOP_215 MACRO_LOOP_214 MACRO_LOOP_CMD(215)
#define MACRO_LOOP_216 MACRO_LOOP_215 MACRO_LOOP_CMD(216)
#define MACRO_LOOP_217 MACRO_LOOP_216 MACRO_LOOP_CMD(217)
#define MACRO_LOOP_218 MACRO_LOOP_217 MACRO_LOOP_CMD(218)
#define MACRO_LOOP_219 MACRO_LOOP_218 MACRO_LOOP_CMD(219)
#define MACRO_LOOP_220 MACRO_LOOP_219 MACRO_LOOP_CMD(220)
#define MACRO_LOOP_221 MACRO_LOOP_220 MACRO_LOOP_CMD(221)
#define MACRO_LOOP_222 MACRO_LOOP_221 MACRO_LOOP_CMD(222)
#define MACRO_LOOP_223 MACRO_LOOP_222 MACRO_LOOP_CMD(223)
#define MACRO_LOOP_224 MACRO_LOOP_223 MACRO_LOOP_CMD(224)
#define MACRO_LOOP_225 MACRO_LOOP_224 MACRO_LOOP_CMD(225)
#define MACRO_LOOP_226 MACRO_LOOP_225 MACRO_LOOP_CMD(226)
#define MACRO_LOOP_227 MACRO_LOOP_226 MACRO_LOOP_CMD(227)
#define MACRO_LOOP_228 MACRO_LOOP_227 MACRO_LOOP_CMD(228)
#define MACRO_LOOP_229 MACRO_LOOP_228 MACRO_LOOP_CMD(229)
#define MACRO_LOOP_230 MACRO_LOOP_229 MACRO_LOOP_CMD(230)
#define MACRO_LOOP_231 MACRO_LOOP_230 MACRO_LOOP_CMD(231)
#define MACRO_LOOP_232 MACRO_LOOP_231 MACRO_LOOP_CMD(232)
#define MACRO_LOOP_233 MACRO_LOOP_232 MACRO_LOOP_CMD(233)
#define MACRO_LOOP_234 MACRO_LOOP_233 MACRO_LOOP_CMD(234)
#define MACRO_LOOP_235 MACRO_LOOP_234 MACRO_LOOP_CMD(235)
#define MACRO_LOOP_236 MACRO_LOOP_235 MACRO_LOOP_CMD(236)
#define MACRO_LOOP_237 MACRO_LOOP_236 MACRO_LOOP_CMD(237)
#define MACRO_LOOP_238 MACRO_LOOP_237 MACRO_LOOP_CMD(238)
#define MACRO_LOOP_239 MACRO_LOOP_238 MACRO_LOOP_CMD(239)
#define MACRO_LOOP_240 MACRO_LOOP_239 MACRO_LOOP_CMD(240)
#define MACRO_LOOP_241 MACRO_LOOP_240 MACRO_LOOP_CMD(241)
#define MACRO_LOOP_242 MACRO_LOOP_241 MACRO_LOOP_CMD(242)
#define MACRO_LOOP_243 MACRO_LOOP_242 MACRO_LOOP_CMD(243)
#define MACRO_LOOP_244 MACRO_LOOP_243 MACRO_LOOP_CMD(244)
#define MACRO_LOOP_245 MACRO_LOOP_244 MACRO_LOOP_CMD(245)
#define MACRO_LOOP_246 MACRO_LOOP_245 MACRO_LOOP_CMD(246)
#define MACRO_LOOP_247 MACRO_LOOP_246 MACRO_LOOP_CMD(247)
#define MACRO_LOOP_248 MACRO_LOOP_247 MACRO_LOOP_CMD(248)
#define MACRO_LOOP_249 MACRO_LOOP_248 MACRO_LOOP_CMD(249)
#define MACRO_LOOP_250 MACRO_LOOP_249 MACRO_LOOP_CMD(250)
#define MACRO_LOOP_251 MACRO_LOOP_250 MACRO_LOOP_CMD(251)
#define MACRO_LOOP_252 MACRO_LOOP_251 MACRO_LOOP_CMD(252)
#define MACRO_LOOP_253 MACRO_LOOP_252 MACRO_LOOP_CMD(253)
#define MACRO_LOOP_254 MACRO_LOOP_253 MACRO_LOOP_CMD(254)
#define MACRO_LOOP_255 MACRO_LOOP_254 MACRO_LOOP_CMD(255)

#define MACRO_LOOP_HELPER(n) MACRO_LOOP_##n
#define MACRO_LOOP(n) MACRO_LOOP_HELPER(n)

#endif
---code
正如头文件里的说明一样，使用还是很简单的：
+++code
#include "macro_loop.h"

//用宏指定循环截止，方便修改
//也可在下文给MACRO_LOOP传常数，但不利于维护
//名称可以任意
#define MARCO_LOOP_X 5

//自己的代码模板，名称可以任意
#define DECLARE(n) int sqr_##n=n*n;

//赋值（或者说是选中）代码模板
#define MACRO_LOOP_CMD(n) DECLARE(n)

//将最后一次选中的代码模板循环MARCO_LOOP_X+1次
//相当于写作DECLARE(0) DECLARE(1) ... DECLARE(5）
MACRO_LOOP(MARCO_LOOP_X)
---code
当然，限制就是，n最大是255。如果想扩大，就自己增加呗~
===============阶段五：探索macro_loop.h的高级用法=============
现实的编程环境往往是复杂的。可能会遇到这么两种情况：
（1）我在一个文件中多次用到宏生成代码的功能。比如我有DECLARE1(n)和DECLARE2(n)，我想把DECLARE1(n)循环4次，而把DECLARE2(n)循环9次；
（2）我不希望从0开始循环，我希望能够从13开始循环，循环到20，即DECLARE(13) DECLARE(14) &#8230; DECLARE(20)。
这两个事情都是能够办到的。
针对第一种情况，解决办法就是重新定义MACRO_LOOP_CMD(n)即可解决：
+++code
#include "macro_loop.h"

#define DECLARE1(n) int sqr_##n=n*n;
#define DECLARE2(n) 2*n,

#define LOOP_1 4
#define LOOP_2 9

#define MACRO_LOOP_CMD(n) DECLARE1(n)
MACRO_LOOP(LOOP_1)

#undef MACRO_LOOP_CMD
#define MACRO_LOOP_CMD(n) DECLARE2(n)
int a[]={MACRO_LOOP(LOOP_2)};
---code
那么生成的代码就是：
+++code
int sqr_0=0*0; int sqr_1=1*1; int sqr_2=2*2; int sqr_3=3*3; int sqr_4=4*4;

int a[]={2*0, 2*1, 2*2, 2*3, 2*4, 2*5, 2*6, 2*7, 2*8, 2*9,};
---code
注意数组定义最后一个逗号，这个是允许的。
关键在于先通过
+++code
#undef MACRO_LOOP_CMD
#define MACRO_LOOP_CMD(n) DECLARE2(n)
---code
重新定义MACRO_LOOP_CMD(n)即可。
针对第二种情况，解决办法就是“破坏”递归链，代码如下：
+++code
#include "macro_loop.h"

#define DECLARE(n) int sqr_##n=n*n;
#undef MACRO_LOOP_12
#define MACRO_LOOP_12
#define LOOP_END 20

#define MACRO_LOOP_CMD(n) DECLARE(n)

MACRO_LOOP(LOOP_END)
---code
原理就是把MACRO_LOOP_12这一个环节定义成空白即可。只可惜语句无法实现参数化，这个目前无法解决。
破坏之后，如果想要修复，那么就：
+++code
#undef MACRO_LOOP_12
#define MACRO_LOOP_12 MACRO_LOOP_11 MACRO_LOOP_CMD(12)
---code
================附注：为啥gcc编译不通过？=================
如果查阅gcc宏定义的处理细节的话会知道，一般的宏展开后，预处理器会再次检查展开的结果是否还能够继续展开。但是，如果展开的结果是通过#或者##产生的，那么不再递归展开。于是，当LOOP(3)只会被展开为LOOP_3，但是不会继续把LOOP_3展开了。。。
</pre>